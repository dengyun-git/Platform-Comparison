---
title: |
  Comparative Analysis of CSF Proteomics Across MS and Olink Platforms
  and Quality Control Validation of MS Data
author: "Yun Deng"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

<!-- Inline CSS for Fire Red Titles -->
<style>
h1 {
color: darkblue; /* set the darkblue color */
font-size: 25px; /* decrease font size */
}
</style>

```{r, Prepare, echo=FALSE, warning=FALSE, message=FALSE, results=F}
# Load required libraries
library(optparse)
library(pheatmap)
library(readxl)
library(tidyverse)
library(magrittr)
library(dplyr)
library(stringr)
library(VennDiagram)
library(LaplacesDemon)
library(philentropy)
library(lsa)
library(ComplexUpset)
library(ggplot2)
library(ggExtra)
library(factoextra)
library(umap)
library(plotly)
library(GGally)
library(cowplot)
library(gridExtra)
library(grid)
library(htmltools)


option_list <- list(
  make_option(c("-i", "--inputPath"), type = "character", default = "/home/rstudio/workspace/Data Collection/",
              help = "Path to input files.", metavar = "INPUT_PATH"),
  make_option(c("-o", "--outPath"), type = "character", default = "/home/rstudio/workspace/Data Collection/output_report/",
              help = "Path to output files.", metavar = "OUTPUT_PATH"),
  make_option(c("-m", "--intermediatePath"), type = "character", default = "/home/rstudio/workspace/Data Collection/oxf-qc2-als-mass-spectometry-wb-genial-hazelnut-7025/Data/intermediate/",
              help = "Path to store intermediate data during processing.", metavar = "MD_PATH"),
  make_option(c("-s", "--codePath"), type = "character", default = "/home/rstudio/repos/Technical Perspective/",
              help = "Path of codes", metavar = "CODE_PATH")
)

# Create an OptionParser object
parser <- OptionParser(option_list = option_list)

# Parse the command-line arguments
args <- parse_args(parser)

# Assign parsed values to variables
inputPath <- args$inputPath
outPath <- args$outPath
intermediatePath <- args$intermediatePath
codePath <- args$codePath

source(paste0(codePath,"Comp_Dataset_Call.R"))

### DEL Protein Naming Scheme Mapping
DEL_ProMap <- read_excel(paste0(inputPath, "oxf-qc2-als-mass-spectometry-wb-genial-hazelnut-7025/Data/output/BEADdel/SAMPLE/BEADdepletions_ProteinMapping.xlsx"))
NON_ProMap <- read_excel(paste0(inputPath, "oxf-qc2-als-mass-spectometry-wb-genial-hazelnut-7025/Data/output/NONdel/SAMPLE/NONDEPLETED_ProteinMapping.xlsx"))

### Read in two datasets
DEL_Sample <-  read.csv(paste0(inputPath, "oxf-qc2-als-mass-spectometry-wb-genial-hazelnut-7025/Data/output/BEADdel/SAMPLE/QCed_Frame.csv"), row.names=1)

NON_Sample <- read.csv(paste0(inputPath,"oxf-qc2-als-mass-spectometry-wb-genial-hazelnut-7025/Data/output/NONdel/SAMPLE/QCed_Frame.csv"), row.names=1)

if(colnames(DEL_Sample)[1] == "PlateID"){
  DEL_Sample <- DEL_Sample[,-1]
  NON_Sample <- NON_Sample[,-1]}
### Using the Entrez Gene Naming scheme
colnames(DEL_Sample) <- sapply(colnames(DEL_Sample), function(x){DEL_ProMap[which(DEL_ProMap$Protein.Group==x),"Genes"]})
colnames(NON_Sample) <- sapply(colnames(NON_Sample), function(x){NON_ProMap[which(NON_ProMap$Protein.Group==x),"Genes"]})

### Raw Data
DEL_Sample_Raw <-  read.csv(paste0(intermediatePath, "BEADdel/SAMPLE/ProDat_RmContam.csv"), sep=",", row.names=1)
NON_Sample_Raw <- read.csv(paste0(intermediatePath, "NONdel/SAMPLE/ProDat_RmContam.csv"), sep=",", row.names=1)
colnames(DEL_Sample_Raw) <- sapply(colnames(DEL_Sample_Raw), function(x){DEL_ProMap[which(DEL_ProMap$Protein.Group==x),"Genes"]})
colnames(NON_Sample_Raw) <- sapply(colnames(NON_Sample_Raw), function(x){NON_ProMap[which(NON_ProMap$Protein.Group==x),"Genes"]})

Olink_Frame <- read.csv(paste0(inputPath, "Data-CSF/oxf-da28-opdc-als-multiple-cohorts-olink-csf/CSF_Customised_ProDataClean.csv"), sep = ",", row.names = 1)

### Check the multiple gene segments within one name
# colnames(Olink_Frame)[grep("\\.",colnames(Olink_Frame))]
# colnames(Olink_Frame)[grep("_",colnames(Olink_Frame))]
# colnames(DEL_Sample_Raw)[grep("\\.",colnames(DEL_Sample_Raw))]
# colnames(NON_Sample_Raw)[grep("\\.",colnames(NON_Sample_Raw))]

### Manually change some protein mapping of Olink to match MS
colnames(Olink_Frame)[which(colnames(Olink_Frame) == "HLA.A")] = "HLA-A"
colnames(Olink_Frame)[which(colnames(Olink_Frame) == "HLA.E")] = "HLA-E"
colnames(Olink_Frame)[which(colnames(Olink_Frame) == "HLA.DRA")] = "HLA-DRA"
colnames(Olink_Frame) <- gsub("_", ".", colnames(Olink_Frame))

```

```{r, read in Color data from Olink and Community results, echo=FALSE, warning=FALSE, message=FALSE}
### Read in Community derived data, three groups of protein names
# clusterObj <- readRDS("/home/rstudio/YD/intermediate/ALS/ModuleDetection_0.25/CORRELATION_LEIDEN_0.1+0.1_clusterObj2.rds")
# clusterInfo <- data.frame("cluster_assignments" = clusterObj$membership, "clustered_nodes" = clusterObj$names)
# 
# StickGp_all <-  clusterObj$names[which(clusterObj$membership == 1)]
# StickGroup <- rep("StickGroup", length(StickGp_all))
# names(StickGroup) <- StickGp_all
# 
# goodCorGp_all <- clusterObj$names[which(clusterObj$membership != 1)]
# goodCorGroup <- rep("GoodCorGroup", length(goodCorGp_all))
# names(goodCorGroup) <- goodCorGp_all
# 
# load(file="/home/rstudio/YD/intermediate/ALS/ModuleDetection_0.25/AMYOTROPHIC LATERAL SCLEROSISexcludePro.rdat")
# UncorGroup <- rep("UncorGroup", length(excludePro)) 
# names(UncorGroup) <- excludePro
# 
# ### Construct the mapping color variable based correlation group derived from community detection
# CommunityGroup <- c(StickGroup, UncorGroup, goodCorGroup)
# 
# names(CommunityGroup)[which(names(CommunityGroup) == "HLA.A")] = "HLA-A"
# names(CommunityGroup)[which(names(CommunityGroup) == "HLA.E")] = "HLA-E"
# names(CommunityGroup)[which(names(CommunityGroup) == "HLA.DRA")] = "HLA-DRA"
# 
# save(CommunityGroup, file = paste0(intermediatePath,"CommunityGroup.rdat"))
# load(paste0(intermediatePath,"CommunityGroup.rdat"))
```

```{r, read in meta data as color information for plot, echo=FALSE, warning=FALSE, message=FALSE}
### Read in Limit of detection meta data for both proteins and samples
combinedP <- read.csv(
  paste0(inputPath,"Data-CSF/oxf-da28-opdc-als-multiple-cohorts-olink-csf/P230192_CSP1-5_CINO_and_C2I2N2O2_EXTENDED_NPX_2024-01-18_cleaned.csv"),sep = ";")

dilutionBinF <- combinedP[,c("Assay","Block")] %>% unique() %>% filter(!grepl("control",Assay))
Block = dilutionBinF$Block
names(Block) <- dilutionBinF$Assay
save(Block, file = paste0(intermediatePath,"BorrowedBlock.rdat"))
# load(paste0(intermediatePath,"BorrowedBlock.rdat"))

# LODF <- combinedP[,c("Assay","LOD")] %>% distinct(Assay, .keep_all = TRUE) %>% filter(!grepl("control", Assay)) %>% mutate(Assay = gsub("_",".", Assay)) %>% mutate(Assay = sub("ERVV-1", "ERVV.1", Assay)) %>% mutate(Assay = sub("NT-proBNP", "NT.proBNP", Assay)) %>% filter(Assay %in% colnames(Olink_Frame))
# LODlist = LODF$LOD
# names(LODlist) <- LODF$Assay
# belowLOD_Protein <- sapply(names(LODlist), function(x){100*length(which(Olink_Frame[,x] < LODlist[x]))/nrow(Olink_Frame)})
# belowLOD_Sample <- sapply(rownames(Olink_Frame), function(x){100*length(which(Olink_Frame[x,] < LODlist[colnames(Olink_Frame)]))/ncol(Olink_Frame)})
# save(belowLOD_Protein, belowLOD_Sample, file = paste0(intermediatePath,"LODlist.rdat"))

# load(paste0(intermediatePath,"LODlist.rdat"))

### Read in clinical meta data
### clinical variables
ALS_ClinicVarF <- read.csv(paste0(inputPath, "DA76/da76-wb-fleeting-cabbage-4050/Data/20251025_als_clinical_with_ambrosia_data_pseudonymized_FINAL.csv"), sep=",")
ClinicVar <- ALS_ClinicVarF$GROUP
names(ClinicVar) <- ALS_ClinicVarF$CSF_OLINK_MANIFEST
save(ClinicVar, file = paste0(intermediatePath,"ClinicVar.rdat"))
#load(paste0(intermediatePath,"ClinicVar.rdat"))
```

```{r, keep here temperarily, echo=FALSE, warning=FALSE, message=FALSE}
KeepCommonSamp <- Reduce(intersect, list(rownames(Olink_Frame),rownames(DEL_Sample),rownames(NON_Sample)))
KeepCommonPro <- Reduce(intersect, list(colnames(Olink_Frame),colnames(DEL_Sample),colnames(NON_Sample)))

combinedP <- read.csv(
  paste0(inputPath,
            "Data-CSF/oxf-da28-opdc-als-multiple-cohorts-olink-csf/P230192_CSP1-5_CINO_and_C2I2N2O2_EXTENDED_NPX_2024-01-18_cleaned.csv"), sep = ";")
                      
Olink_Frame_keep <- Olink_Frame[KeepCommonSamp,KeepCommonPro]

LODF <- combinedP[,c("Assay","LOD")] %>% distinct(Assay, .keep_all = TRUE) %>% filter(!grepl("control", Assay)) %>% mutate(Assay = gsub("_",".", Assay)) %>% mutate(Assay = sub("ERVV-1", "ERVV.1", Assay)) %>% mutate(Assay = sub("NT-proBNP", "NT.proBNP", Assay)) %>% filter(Assay %in% colnames(Olink_Frame_keep))

LODlist = LODF$LOD
names(LODlist) <- LODF$Assay
belowLOD_Protein <- sapply(names(LODlist), function(x){100*length(which(Olink_Frame_keep[,x] < LODlist[x]))/nrow(Olink_Frame_keep)})
belowLOD_Sample <- sapply(rownames(Olink_Frame_keep), function(x){100*length(which(Olink_Frame_keep[x,] < LODlist[colnames(Olink_Frame_keep)]))/ncol(Olink_Frame_keep)})

```

# Overlap for Samples and Proteins{.tabset}
<b><font face="Georgia" size="2em" color="#000000"> The overlapping are based on MS and Olink data sets after quality control.</font></b>

## Proteins{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = colnames(Olink_Frame),
  "MSbd" = colnames(DEL_Sample),
  "MS_NON" = colnames(NON_Sample)
)

elements <- unique(unlist(set_list))  # Extract all unique elements from sets

binary_matrix <- as.data.frame(
  sapply(set_list, function(x) elements %in% x)
)
rownames(binary_matrix) <- elements
colnames(binary_matrix) <- names(set_list)

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),
  name = "Proteins in Platforms"
)
```

## Samples{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = rownames(Olink_Frame),
  "MSbd" = rownames(DEL_Sample),
  "MS_NON" = rownames(NON_Sample)
)

elements <- unique(unlist(set_list))  
binary_matrix <- as.data.frame(
  sapply(set_list, function(set) elements %in% set)  
)
rownames(binary_matrix) <- elements  
colnames(binary_matrix) <- names(set_list) 

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),  # Use the names of the sets as intersection columns
  name = "Samples in Platformss"  # Label for the UpSet plot
)
```

# Protein Specific Intraplatform and Interplatform Correlation{.tabset}
<b><font face="Georgia" size="2em" color="#000000"> For Protein Specific Intraplatform and Interplatform Correlation calculation between two data sets, common proteins and common samples between those two data sets are used.</font></b>

## Pearson{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 9,  warning=FALSE, message=FALSE}
p1 <- scatterHist(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, "Protein", "pearson", "", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON")

p2 <- scatterHist(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, "Protein", "pearson", "", "Olink vs Raw MSbd", "Olink vs QCed MSbd")

p3 <- scatterHist(DEL_Sample_Raw, NON_Sample_Raw, DEL_Sample, NON_Sample, "Protein", "pearson", "", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd")

p4 <- scatterHist(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample,"Protein", "pearson", "", "Olink vs QCed MSbd", "Olink vs QCed MS_NON")

title <- ggdraw() + draw_label("Protein Specific Pearson Correlation", fontface = 'bold', size = 14) 

plot_row <- plot_grid(p1, p2, p3, p4, nrow=2, align = "hv", labels = c("A", "B", "C", "D"))

final_plot <- plot_grid(title, plot_row, ncol=1, rel_heights = c(0.1,0.9))

print(final_plot)

```

```{r, echo=FALSE, fig.width = 6, fig.height = 6, warning=FALSE, message=FALSE}
plots <- list()

p1 <- interactiveRHO(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, Block,  "Protein", "pearson", "Protein Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Dilution Bin")

p2 <- interactiveRHO(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, Block, "Protein", "pearson", "Protein Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Dilution Bin")

p3 <- interactiveRHO(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample, Block, "Protein", "pearson", "Protein Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Dilution Bin")

p4 <- interactiveRHO(NON_Sample_Raw, DEL_Sample_Raw, NON_Sample, DEL_Sample, Block, "Protein", "pearson", "Protein Specific Pearson Correlation", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd", "Dilution Bin")

p5 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Protein,  "Protein", "pearson", "Protein Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Proportion of Samples Below LOD (%)")

p6 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Protein, "Protein", "pearson", "Protein Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Proportion of Samples Below LOD (%)")

p7 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Protein, "Protein", "pearson", "Protein Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Proportion of Samples Below LOD (%)")

plots <- append(plots, list(p1, p2, p3, p4, p5, p6, p7))

tagList(plots)

```


## Spearman{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 9,  warning=FALSE, message=FALSE}
p1 <- scatterHist(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, "Protein", "spearman", "", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON")

p2 <- scatterHist(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, "Protein", "spearman", "", "Olink vs Raw MSbd", "Olink vs QCed MSbd")

p3 <- scatterHist(DEL_Sample_Raw, NON_Sample_Raw, DEL_Sample, NON_Sample, "Protein", "spearman", "", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd")

p4 <- scatterHist(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample,"Protein", "spearman", "", "Olink vs QCed MSbd", "Olink vs QCed MS_NON")

title <- ggdraw() + draw_label("Protein Specific Spearman Correlation", fontface = 'bold', size = 14) 

plot_row <- plot_grid(p1, p2, p3, p4, nrow=2, align = "hv", labels = c("A", "B", "C", "D"))

final_plot <- plot_grid(title, plot_row, ncol=1, rel_heights = c(0.1,0.9))

print(final_plot)

```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
plots <- list()

p1 <- interactiveRHO(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, Block,  "Protein", "spearman", "Protein Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Dilution Bin")

p2 <- interactiveRHO(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, Block, "Protein", "spearman", "Protein Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Dilution Bin")

p3 <- interactiveRHO(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample, Block, "Protein", "spearman", "Protein Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Dilution Bin")

p4 <- interactiveRHO(NON_Sample_Raw, DEL_Sample_Raw, NON_Sample, DEL_Sample, Block, "Protein", "spearman", "Protein Specific Pearson Correlation", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd", "Dilution Bin")

p5 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Protein,  "Protein", "spearman", "Protein Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Proportion of Samples Below LOD (%)")

p6 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Protein, "Protein", "spearman", "Protein Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Proportion of Samples Below LOD (%)")

p7 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Protein, "Protein", "spearman", "Protein Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Proportion of Samples Below LOD (%)")

plots <- append(plots, list(p1, p2, p3, p4, p5, p6, p7))

tagList(plots)

```

<!-- ## Jensen–Shannon Divergence {.tabset} -->
<!-- <b><font face="Georgia" size="2em" color="#000000"> Jensen–Shannon divergence measures the similarity between two probability distributions. </font></b> -->

<!-- ```{r, echo=FALSE, results = FALSE, warning=FALSE, message=FALSE} -->
<!-- # JS_divergence <- getIndividualJS(NON_Sample, DEL_Sample, "Protein", "QCed MS_NON vs QCed MSbd") -->

<!-- ``` -->

## MS Data at Different Normliastion Stages{.tabset}
<b><font face="Georgia" size="2em" color="#000000"> Investigate whether particular MS data processing steps distort protein correlation.</font></b>

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# fileList <- grep("csv",list.files("/home/rstudio/YD/MS/intermediate/BEADdel/SAMPLE/", pattern = "ProDat_"), value = TRUE)
fileList <- c("ProDat_RmContam.csv", "ProDat_RmLargeMiss.csv", "ProDat_RFimput.csv", "ProDat_RMoutlier.csv", "ProDat_BatchCorrected.csv")
plots <- list()

for(whichFile in fileList){
  DEL_Sample_DiffNorm <-  read.csv(paste0(intermediatePath, "BEADdel/SAMPLE/", whichFile), sep = ",", row.names = 1)
  NON_Sample_DiffNorm <- read.csv(paste0(intermediatePath, "NONdel/SAMPLE/", whichFile), sep = ",", row.names = 1)
  
  colnames(DEL_Sample_DiffNorm) <- sapply(colnames(DEL_Sample_DiffNorm), function(x){DEL_ProMap[which(DEL_ProMap$Protein.Group==x),"Genes"]})
  colnames(NON_Sample_DiffNorm) <- sapply(colnames(NON_Sample_DiffNorm), function(x){NON_ProMap[which(NON_ProMap$Protein.Group==x),"Genes"]})
  
  pearsonCor1 <- getIndividualRelation(Olink_Frame, NON_Sample_DiffNorm, "Protein", "pearson")
  pearsonCor2 <- getIndividualRelation(Olink_Frame, DEL_Sample_DiffNorm, "Protein", "pearson")
  pearsonCor3 <- getIndividualRelation(DEL_Sample_DiffNorm, NON_Sample_DiffNorm, "Protein", "pearson")
  
  common_elements <- Reduce(intersect, list(names(pearsonCor1), names(pearsonCor2), names(pearsonCor3)))
  
  par(mfrow=c(1,3))
  hist(pearsonCor1, breaks=100, xlab = paste0(length(intersect(rownames(Olink_Frame), rownames(NON_Sample_DiffNorm))), " Samples ", length(intersect(colnames(Olink_Frame), colnames(NON_Sample_DiffNorm))), " Proteins"), xlim = c(-1,1), main=paste0("Protein Pearson Correlation\nOlink vs MS_NON ", sub(".csv","",whichFile)), cex.main=0.9)
  hist(pearsonCor2, breaks=100, xlab = paste0(length(intersect(rownames(Olink_Frame), rownames(DEL_Sample_DiffNorm))), " Samples ", length(intersect(colnames(Olink_Frame), colnames(DEL_Sample_DiffNorm))), " Proteins"), xlim = c(-1,1), main=paste0("Protein Pearson Correlation\nOlink vs MSbd", sub(".csv","",whichFile)), cex.main=0.9)
  hist(pearsonCor3, breaks=100, xlab = paste0(length(intersect(rownames(NON_Sample_DiffNorm), rownames(DEL_Sample_DiffNorm))), " Samples ", length(intersect(colnames(NON_Sample_DiffNorm), colnames(DEL_Sample_DiffNorm))), " Proteins"), xlim = c(-1,1), main=paste0("Protein Pearson Correlation\n MS_NON vs MSbd", sub(".csv","",whichFile)), cex.main=0.9)
}
```


# Sample Specific Intraplatform and Interplatform Correlation{.tabset}
<b><font face="Georgia" size="2em" color="#000000"> For Sample Specific Intraplatform and Interplatform Correlation  calculation between two data sets, common proteins and common samples between those two data sets are used.</font></b>

## Pearson{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 9,  warning=FALSE, message=FALSE}
p1 <- scatterHist(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, "Sample", "pearson", "", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON")

p2 <- scatterHist(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, "Sample", "pearson", "", "Olink vs Raw MSbd", "Olink vs QCed MSbd")

p3 <- scatterHist(DEL_Sample_Raw, NON_Sample_Raw, DEL_Sample, NON_Sample, "Sample", "pearson", "", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd")

p4 <- scatterHist(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample,"Sample", "pearson", "", "Olink vs QCed MSbd", "Olink vs QCed MS_NON")

title <- ggdraw() + draw_label("Sample Specific Pearson Correlation", fontface = 'bold', size = 14) 

plot_row <- plot_grid(p1, p2, p3, p4, nrow=2, align = "hv", labels = c("A", "B", "C", "D"))

final_plot <- plot_grid(title, plot_row, ncol=1, rel_heights = c(0.1,0.9))

print(final_plot)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}

plots <- list()

p1 <- interactiveRHO(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, ClinicVar, "Sample", "pearson", "Sample Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Disease Group")

p2 <- interactiveRHO(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, ClinicVar, "Sample", "pearson", "Sample Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Disease Group")

p3 <- interactiveRHO(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample, ClinicVar,"Sample", "pearson", "Sample Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Disease Group")

p4 <- interactiveRHO(NON_Sample_Raw, DEL_Sample_Raw, NON_Sample, DEL_Sample, ClinicVar, "Sample", "pearson", "Sample Specific Pearson Correlation", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd", "Disease Group")

p5 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Sample, "Sample", "pearson", "Sample Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Proportion of Proteins Below LOD (%)")

p6 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Sample, "Sample", "pearson", "Sample Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Proportion of Proteins Below LOD (%)")

p7 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Sample, "Sample", "pearson", "Sample Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Proportion of Proteins Below LOD (%)")

plots <- append(plots, list(p1, p2, p3, p4, p5, p6, p7))

tagList(plots)

```

## Spearman{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 9,  warning=FALSE, message=FALSE}
p1 <- scatterHist(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, "Sample", "spearman", "", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON")

p2 <- scatterHist(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, "Sample", "spearman", "", "Olink vs Raw MSbd", "Olink vs QCed MSbd")

p3 <- scatterHist(DEL_Sample_Raw, NON_Sample_Raw, DEL_Sample, NON_Sample, "Sample", "spearman", "", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd")

p4 <- scatterHist(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample,"Sample", "spearman", "", "Olink vs QCed MSbd", "Olink vs QCed MS_NON")

title <- ggdraw() + draw_label("Sample Specific Spearman Correlation", fontface = 'bold', size = 14) 

plot_row <- plot_grid(p1, p2, p3, p4, nrow=2, align = "hv", labels = c("A", "B", "C", "D"))

final_plot <- plot_grid(title, plot_row, ncol=1, rel_heights = c(0.1,0.9))

print(final_plot)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}

plots <- list()

p1 <- interactiveRHO(Olink_Frame, NON_Sample_Raw, Olink_Frame, NON_Sample, ClinicVar, "Sample", "spearman", "Sample Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Disease Group")

p2 <- interactiveRHO(Olink_Frame, DEL_Sample_Raw, Olink_Frame, DEL_Sample, ClinicVar, "Sample", "spearman", "Sample Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Disease Group")

p3 <- interactiveRHO(Olink_Frame, DEL_Sample, Olink_Frame, NON_Sample, ClinicVar,"Sample", "spearman", "Sample Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Disease Group")

p4 <- interactiveRHO(NON_Sample_Raw, DEL_Sample_Raw, NON_Sample, DEL_Sample, ClinicVar, "Sample", "spearman", "Sample Specific Pearson Correlation", "Raw MS_NON vs Raw MSbd", "QCed MS_NON vs QCed MSbd", "Disease Group")

p5 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Sample, "Sample", "spearman", "Sample Specific Pearson Correlation", "Olink vs Raw MS_NON", "Olink vs QCed MS_NON", "Proportion of Proteins Below LOD (%)")

p6 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample_Raw[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Sample, "Sample", "spearman", "Sample Specific Pearson Correlation", "Olink vs Raw MSbd", "Olink vs QCed MSbd", "Proportion of Proteins Below LOD (%)")

p7 <- interactiveRHO(Olink_Frame[KeepCommonSamp, KeepCommonPro], DEL_Sample[KeepCommonSamp, KeepCommonPro], Olink_Frame[KeepCommonSamp, KeepCommonPro], NON_Sample[KeepCommonSamp, KeepCommonPro], belowLOD_Sample, "Sample", "spearman", "Sample Specific Pearson Correlation", "Olink vs QCed MSbd", "Olink vs QCed MS_NON", "Proportion of Proteins Below LOD (%)")

plots <- append(plots, list(p1, p2, p3, p4, p5, p6, p7))

tagList(plots)
```

## MS Data at Different Normliastion Stages{.tabset}
<b><font face="Georgia" size="2em" color="#000000"> Investigate whether particular MS data processing steps distort sample correlation.</font></b>

```{r, echo=FALSE, warning=FALSE, message=FALSE}

for(whichFile in fileList){
  DEL_Sample_DiffNorm <-  read.csv(paste0(intermediatePath, "BEADdel/SAMPLE/", whichFile), sep = ",", row.names = 1)
  NON_Sample_DiffNorm <- read.csv(paste0(intermediatePath, "NONdel/SAMPLE/", whichFile), sep = ",", row.names = 1)
  
  colnames(DEL_Sample_DiffNorm) <- sapply(colnames(DEL_Sample_DiffNorm), function(x){DEL_ProMap[which(DEL_ProMap$Protein.Group==x),"Genes"]})
  colnames(NON_Sample_DiffNorm) <- sapply(colnames(NON_Sample_DiffNorm), function(x){NON_ProMap[which(NON_ProMap$Protein.Group==x),"Genes"]})
  
  pearsonCor1 <- getIndividualRelation(Olink_Frame, DEL_Sample_DiffNorm, "Sample", "pearson")
  pearsonCor2 <- getIndividualRelation(Olink_Frame, NON_Sample_DiffNorm, "Sample", "pearson")
  pearsonCor3 <- getIndividualRelation(DEL_Sample_DiffNorm, NON_Sample_DiffNorm, "Sample", "pearson")
  
  common_elements <- Reduce(intersect, list(names(pearsonCor1), names(pearsonCor2), names(pearsonCor3)))
  
  par(mfrow=c(1,3))
  hist(pearsonCor2, breaks=100, xlab = paste0(length(intersect(rownames(Olink_Frame), rownames(NON_Sample_DiffNorm))), "Samples ", length(intersect(colnames(Olink_Frame), colnames(NON_Sample_DiffNorm))), " Proteins"), xlim = c(-1,1), main=paste0("Sample Pearson Correlation\nOlink vs MS ", sub(".csv","",whichFile)), cex.main = 0.8)
  hist(pearsonCor1, breaks=100, xlab = paste0(length(intersect(rownames(Olink_Frame), rownames(DEL_Sample_DiffNorm))), "Samples ", length(intersect(colnames(Olink_Frame), colnames(DEL_Sample_DiffNorm))), " Proteins"), xlim = c(-1,1), main=paste0("Sample Pearson Correlation\nOlink vs MSbd", sub(".csv","",whichFile)), cex.main = 0.8)
  hist(pearsonCor3, breaks=100, xlab = paste0(length(intersect(rownames(NON_Sample_DiffNorm), rownames(DEL_Sample_DiffNorm))), "Samples ", length(intersect(colnames(NON_Sample_DiffNorm), colnames(DEL_Sample_DiffNorm))), " Proteins"), xlim = c(-1,1), main=paste0("Sample Pearson Correlation\n MS vs MSbd", sub(".csv","",whichFile)), cex.main = 0.8)
  
}  
```

# Intraplatform and Interplatform Similarity of Global Data Structure{.tabset}
<b><font face="Georgia" size="2em" color="#000000"> We construct the adjacency matrix based on the connectivity between proteins based on their Spearman correlation coefficients, then we look into the protein coexpression patterns. </font></b>

## Olink Protein Coexpression Structure{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 3, warning=FALSE, message=FALSE}
all_overlap_sample <- Reduce(intersect, list(rownames(DEL_Sample), rownames(NON_Sample), rownames(Olink_Frame)))
all_overlap_protein <- Reduce(intersect, list(colnames(DEL_Sample), colnames(NON_Sample), colnames(Olink_Frame)))

HeatMapLabels <- list(textGrob("A", x = 0.05, y = 0.7, gp = gpar(fontsize = 13, fontface = "bold")),
               textGrob("B", x = 0.05, y = 0.7, gp = gpar(fontsize = 13, fontface = "bold")),
               textGrob("C", x = 0.05, y = 0.7, gp = gpar(fontsize = 13, fontface = "bold")))

ordered_row_names_Olink <- getRowOrder(Olink_Frame[all_overlap_sample, all_overlap_protein], "spearman", "Olink")
p1 <- PlotAdjM(Olink_Frame[all_overlap_sample, ordered_row_names_Olink], "spearman", "Olink")
p2 <- PlotAdjM(NON_Sample[all_overlap_sample, ordered_row_names_Olink], "spearman", "Entries Replaced with MS_NON")
p3 <- PlotAdjM(DEL_Sample[all_overlap_sample, ordered_row_names_Olink], "spearman", "Entries Replaced with MSbd")

grid.arrange(
  grobs = list(arrangeGrob(p1[[4]], top = HeatMapLabels[[1]]),
               arrangeGrob(p2[[4]], top = HeatMapLabels[[2]]),
               arrangeGrob(p3[[4]], top = HeatMapLabels[[3]])),
  nrow = 1
)

```

## MS_NON Protein Coexpression Structure{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 3, warning=FALSE, message=FALSE}
ordered_row_names_NON <- getRowOrder(NON_Sample[all_overlap_sample, all_overlap_protein], "spearman", "MS_NON")
p1 <- PlotAdjM(NON_Sample[all_overlap_sample, ordered_row_names_NON], "spearman", "MS_NON")
p2 <- PlotAdjM(Olink_Frame[all_overlap_sample, ordered_row_names_NON], "spearman", "Entries Replaced with Olink")
p3 <- PlotAdjM(DEL_Sample[all_overlap_sample, ordered_row_names_NON], "spearman", "Entries Replaced with MSbd")
grid.arrange(
  grobs = list(arrangeGrob(p1[[4]], top = HeatMapLabels[[1]]),
               arrangeGrob(p2[[4]], top = HeatMapLabels[[2]]),
               arrangeGrob(p3[[4]], top = HeatMapLabels[[3]])),
  nrow = 1
)
```

## MSbd Protein Coexpression Structure{.tabset}
```{r, echo=FALSE, fig.width = 9, fig.height = 3, warning=FALSE, message=FALSE}
ordered_row_names_DEL <- getRowOrder(DEL_Sample[all_overlap_sample, all_overlap_protein], "spearman", "MSbd")
p1 <- PlotAdjM(DEL_Sample[all_overlap_sample, ordered_row_names_DEL], "spearman", "MSbd")
p2 <- PlotAdjM(Olink_Frame[all_overlap_sample, ordered_row_names_DEL], "spearman", "Entries Replaced with Olink")
p3 <- PlotAdjM(NON_Sample[all_overlap_sample, ordered_row_names_DEL], "spearman", "Entries Replaced with MS_NON")
grid.arrange(
  grobs = list(arrangeGrob(p1[[4]], top = HeatMapLabels[[1]]),
               arrangeGrob(p2[[4]], top = HeatMapLabels[[2]]),
               arrangeGrob(p3[[4]], top = HeatMapLabels[[3]])),
  nrow = 1
)
```

#```{r}
# Rscript -e "rmarkdown::render('presentation_2025.Rmd', output_dir = '/home/rstudio/workspace/Data Collection/output_report/')"
#```