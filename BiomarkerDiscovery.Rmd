---
title: "Comparative Analysis of CSF Proteomics for Biomarker Discovery Across MS and Olink Platforms:
Protein Differential Expression and Associations with Clinical Traits"

# author: ""
# date: "`r Sys.Date()`"
output: 
  rmdformats::robobook:
    fig_width: 9
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.width = 6, fig.height = 4,
                      cache=FALSE, cache.lazy = FALSE,
                      fig.align = 'center',
                      tidy.opts = list(width.cutoff = 80), 
                      tidy = TRUE)

library(kableExtra)
```

```{=html}
<style type="text/css">
.book .book-body .page-inner {
max-width: 1600px;
margin-left: auto;
margin-right: auto;
}
details > summary {
display: list-item;
}
</style>
```       

# 1 - Global Summary of the Setting of this Study

1. **Proteomic Platforms:**  
We analyzed proteomic data from three different platforms:  
- **Olink**  
- **Mass Spectrometry with bead depletion (BEADdel, referred to as BEADdel in this report)**  
- **Mass Spectrometry without bead depletion (NONdel, referred to as NONdel in this report)**

2. **Analytical Approaches:**  
Two complementary approaches were used to explore potential protei biomarkers:  
- **Protein Differential Expression Analysis:** Regression models with protein levels as the **response variable**.  
- **Association Testing:** Regression models with protein levels as the **predictor variable**.  

These approaches were chosen to capture different structural patterns in the proteomic data.

3. **Analysis Scope:**  
Both differential expression analysis and association testing were performed **per platform and per clinical trait**.

4. **Clinical Variables:**  
The clinical variables included in this report are:  
- `"ALSvsHC"`, `"ALSvsDC"`, `"DCvsHC"`, `"ALSFRSR_FINE_MOTOR"`, `"ALSFRSR_GROSS_MOTOR"`, `"ALSFRSR_RATE"`, `"ECAS_SCORE"`  
- `"BULBARvSpinal"` – derived from `WEAKNESS_SITE`, where `"GENERALISED"`, `"LOWER LIMB"`, `"RESPIRATORY"`, `"TRUNCAL"`, and `"UPPER LIMB"` are grouped as `"Spinal"`  
- `"C9vsNonC9"` – derived from `PATHOGENIC_VARIANT`, where `"KIF5A", "MAPT", "SBMA", "SOD1", "SPG7", "TBK1"` are grouped as NonC9 carriers  

**Data transformations:**  
- `ALSFRSR_RATE` – log-transformed  
- `ECAS_SCORE` – Box-Cox transformed with a maximum value of 134  
- `ALSFRSR_FINE_MOTOR` and `ALSFRSR_GROSS_MOTOR` – Box-Cox transformed with a maximum value of 12

5. **Handling Missing Values and Confounders:**  
- Missing values were **excluded on a per-regression basis**.  
- **Age and gender** were included as confounding factors in all regression models.

6. **Pathway Enrichment Testing:**  
- Performed **per platform and per clinical trait**.  
- The pathway databases included are: `"GOBP"`, `"GOMF"`, `"GOCC"`, `"REACTOME"`, `"KEGG"`, `"Biocarta"`, and `"WikiPathways"`.  
- **Ranked Gene Set Enrichment Testing** was adopted, using the ranking metric:  
\[
\text{Rank} = -\log(p) \times \text{sign}(\beta)
\]  
where `p` and `β` are derived from the respective regression model.

# 2 - The Major Conclusions

<b><font face="Georgia" size="2em" color="firebrick"> Wait Avi to fill in. </font></b>

# 3 - Overlap for Samples and Proteins{.tabset}

<b><font face="Georgia" size="2em" color="firebrick"> Note: The overlapping are based on MS and Olink data sets after quality control and only the baseline samples are included in the analysis for this report.</font></b>

```{r, Load Data, echo=FALSE, warning=FALSE, message=FALSE, results=F}
library(kableExtra)
library(plotly)
library(DT)

inputPath <- "/home/rstudio/workspace/Data Collection/"
intermediatePath1 <- "/home/rstudio/workspace/Data Collection/intermediate_AssociationTesting/"
intermediatePath2 <- "/home/rstudio/workspace/Data Collection/intermediate_DifferentialExpression/"
outPath1 <- "/home/rstudio/workspace/Data Collection/output_AssociationTesting/"
outPath2 <- "/home/rstudio/workspace/Data Collection/output_DifferentialExpression/"
outPath <- "/home/rstudio/workspace/Data Collection/output_report/"

source("/home/rstudio/repos/DE_functions_call.R")

load(file = paste0(inputPath, "output_report/Load_Data_For_Report.rdata"))

platformList <- c("Olink", "BEADdel", "NONdel")

varAll_List <- c("ALSvsHC", "ALSvsDC", "DCvsHC", "BULBARvSpinal", "C9vsNonC9", "ALSFRSR_FINE_MOTOR", "ALSFRSR_GROSS_MOTOR", "ALSFRSR_RATE", "ECAS_SCORE")

varList_Conf <- c("AGE_AT_SYMPTOM_ONSET", "AGE_AT_SAMPLING","GENDER", "COHORT")
```

## 3.1 - Proteins{.tabset}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = colnames(Olink_ProF_matchClinic),
  "BEADdel" = colnames(BEADdel_ProF_matchClinic),
  "NONdel" = colnames(NONdel_ProF_matchClinic)
)

elements <- unique(unlist(set_list))  # Extract all unique elements from sets

binary_matrix <- as.data.frame(
  sapply(set_list, function(x) elements %in% x)
)
rownames(binary_matrix) <- elements
colnames(binary_matrix) <- names(set_list)

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),
  name = "Proteins in Platforms"
)
```


## 3.2 - Samples{.tabset}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = rownames(Olink_ProF_matchClinic),
  "BEADdel" = rownames(BEADdel_ProF_matchClinic),
  "NONdel" = rownames(NONdel_ProF_matchClinic)
)

elements <- unique(unlist(set_list))  
binary_matrix <- as.data.frame(
  sapply(set_list, function(set) elements %in% set)  
)
rownames(binary_matrix) <- elements  
colnames(binary_matrix) <- names(set_list) 

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),  
  name = "Samples in Platformss"  
)
```

# 4 - Clinincal Variable View{.tabset}
## All Clinical Variables {.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
load(file = paste0(intermediatePath1, "ClinicVar_View.Rdata"))
All_ClinicVar_View
```

## Olink{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
Olink_ClinicVar_View
```

## MS BEADdel{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
BEADdel_ClinicVar_View
```

## MS NONdel{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
NONdel_ClinicVar_View
```

# 6 - Volcano Plot{.tabset}
These plots are derived from the protein correlation coefficients obtained from the association testing model for each clinical trait.

```{r, results='asis', echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=8}

# Load plots
load(paste0(intermediatePath1, "volcano_panel_list.rdata"))
load(paste0(intermediatePath1, "plotly_volcano_list.rdata"))

for (trait in varAll_List) {
  
  out <- NULL
  uniq_id <- sample(1e6, 1)  # generate a random number for uniqueness
  
  # Static plot
  out <- c(out, 
           paste0("```{r StaticVolcano_", trait, "_", uniq_id, ", echo=FALSE, fig.width=15, fig.height=8}"),
           paste0("volcano_panel_list[['", trait, "']]"),
           "```")
  
  # Interactive plots
  for (plat in platformList) {
    uniq_id2 <- sample(1e6, 1)
    out <- c(out,
             paste0("```{r InteractiveVolcano_", trait, "_", plat, "_", uniq_id2, ", echo=FALSE, fig.width=15, fig.height=8}"),
             paste0("plotly_volcano_list[['", trait, "']][['", plat, "']]"),
             "```")
  }
  
  cat(knitr::knit_child(text = paste(out, collapse = "\n"), quiet = TRUE), sep = "\n")
}
```

# 7 - Pathway Enrichment Testing{.tabset}

# 7.1 - Pathway Enrichment Analysis Based on Association Testing, Using Proteins as Predictors{.tabset}
```{r pathway_plots_nested_tabs, results='asis', echo=FALSE}
load(paste0(outPath1, "ply_list.rdata"))
options(plotly.export = FALSE)
options(htmlwidgets.TEMP = FALSE)

pathBaseList <- c("GOBP","GOMF","GOCC","REACTOME","KEGG","Biocarta","WikiPathways") 

chunk_id <- 1   # ensure uniqueness

for (trait in varAll_List) {
  
  # ---- FIRST-LEVEL TAB: CLINICAL TRAIT ----
  cat("##", trait, "\n\n")
  
  for (db in pathBaseList) {
    
    # ---- SECOND-LEVEL TAB: DATABASE ----
    cat("###", db, "\n\n")
    
    # find matching entry in ply_list
    ply_pattern <- paste0(db, "_", trait)
    idx <- grep(ply_pattern, names(ply_list))
    
    if (length(idx) == 1) {
      key <- names(ply_list)[idx]
      
      # create guaranteed-unique chunk label
      chunk_label <- paste0("PlotChunk_", chunk_id)
      chunk_id <- chunk_id + 1
      
      # output the plot chunk
      cat(paste0(
        "```{r ", chunk_label, ", echo=FALSE}\n",
        "plotly::plotly_build(ply_list[['", key, "']])\n",
        "```\n\n"
      ))
    }
  }
}

```

# 7.2 - Pathway Enrichment Analysis Based on Differential Expression, Using Proteins as Response Variables{.tabset}
```{r, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
load(paste0(outPath2, "ply_list.rdata"))

chunk_id <- 1   # ensure uniqueness

for (trait in varAll_List) {
  
  # ---- FIRST-LEVEL TAB: CLINICAL TRAIT ----
  cat("##", trait, "\n\n")
  
  for (db in pathBaseList) {
    
    # ---- SECOND-LEVEL TAB: DATABASE ----
    cat("###", db, "\n\n")
    
    # find matching entry in ply_list
    ply_pattern <- paste0(db, "_", trait)
    idx <- grep(ply_pattern, names(ply_list))
    
    if (length(idx) == 1) {
      key <- names(ply_list)[idx]
      
      # create guaranteed-unique chunk label
      chunk_label <- paste0("PlotChunk_", chunk_id)
      chunk_id <- chunk_id + 1
      
      # output the plot chunk
      cat(paste0(
        "```{r ", chunk_label, ", echo=FALSE}\n",
        "plotly::plotly_build(ply_list[['", key, "']])\n",
        "```\n\n"
      ))
    }
  }
}
```

# 8 - Summary Table of Overlapping Biomarker Candidate{.tabset} 

# 8.1 - Combined Biomarker Candidate from Two Complemetary Approaches with Comparisons Acorss the Three Platforms {.tabset} 
## 8.1.1 - Protein Names in Display
```{r, echo=FALSE, warning=FALSE, message=FALSE}
SigProSummary_AT <- read.csv(paste0(outPath1, "SigProSummary.csv"))
SigProSummary_DE <- read.csv(paste0(outPath2, "SigProSummary.csv"))

# Get all unique ClinicalVar from both data frames
all_clinical <- SigProSummary_AT$ClinicalVar

# Initialize an empty list to store results
result_list <- vector("list", length(all_clinical))

# Function to merge protein strings
merge_proteins <- function(a, b) {
  a <- ifelse(is.na(a), "", a)
  b <- ifelse(is.na(b), "", b)
  combined <- unique(unlist(str_split(c(a, b), "/")))
  combined <- combined[combined != ""]
  paste(combined, collapse = "/")
}

# Loop over all ClinicalVar
for (i in seq_along(all_clinical)) {
  var <- all_clinical[i]
  
  row_AT <- SigProSummary_AT %>% filter(ClinicalVar == var)
  row_DE <- SigProSummary_DE %>% filter(ClinicalVar == var)
  
  BEADdel <- merge_proteins(if(nrow(row_AT) > 0) row_AT$BEADdel else NA,
                            if(nrow(row_DE) > 0) row_DE$BEADdel else NA)
  
  NONdel  <- merge_proteins(if(nrow(row_AT) > 0) row_AT$NONdel else NA,
                            if(nrow(row_DE) > 0) row_DE$NONdel else NA)
  
  Olink   <- merge_proteins(if(nrow(row_AT) > 0) row_AT$Olink else NA,
                            if(nrow(row_DE) > 0) row_DE$Olink else NA)
  
  result_list[[i]] <- data.frame(
    ClinicalVar = var,
    BEADdel = BEADdel,
    NONdel  = NONdel,
    Olink   = Olink,
    stringsAsFactors = FALSE
  )
}

# Combine into final data frame
SigProSummary <- bind_rows(result_list)

# View result
DT::datatable(SigProSummary)
```

## 8.1.2 - Overlap Counts Across Platforms 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
summary_list <- lapply(varAll_List, function(var) {
  
  # Get the row for this ClinicalVar
  row <- SigProSummary %>% filter(ClinicalVar == var)
  
  # Split protein strings into vectors (handle empty or NA)
  s_bead <- if(nchar(row$BEADdel) > 0) unlist(strsplit(row$BEADdel, "/")) else character(0)
  s_non  <- if(nchar(row$NONdel)  > 0) unlist(strsplit(row$NONdel,  "/")) else character(0)
  s_ol   <- if(nchar(row$Olink)   > 0) unlist(strsplit(row$Olink,   "/")) else character(0)
  
  # Compute overlaps
  overlap_BEADdel_NONdel <- intersect(s_bead, s_non)
  overlap_BEADdel_Olink  <- intersect(s_bead, s_ol)
  overlap_NONdel_Olink   <- intersect(s_non, s_ol)
  overlap_all3           <- Reduce(intersect, list(s_bead, s_non, s_ol))
  
  # Return summary data.frame
  data.frame(
    ClinicalVar = var,
    Comparison = c("BEADdel vs NONdel", "BEADdel vs Olink", "NONdel vs Olink", "All three"),
    nProteins  = c(
      length(overlap_BEADdel_NONdel),
      length(overlap_BEADdel_Olink),
      length(overlap_NONdel_Olink),
      length(overlap_all3)
    ),
    stringsAsFactors = FALSE
  )
})

# Combine into a single data frame
summary_df <- do.call(rbind, summary_list)

# View result
summary_df
```

# 8.2 - Biomarker Candidate Derived from Association Testing with Comparisons Acorss the Three Platforms {.tabset} 
## 8.2.1 Protein Names in Display
```{r, echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(SigProSummary_DE)
```
# 8.2.2 - Overlap Counts
```{r, echo=FALSE, warning=FALSE, message=FALSE}
summary_df_AT <- read.csv(paste0(outPath1, "overlap_summary_counts.csv"))
DT::datatable(summary_df_AT)
```

# 8.3 - Biomarker Candidate Derived from Differential Expression with Comparisons Acorss the Three Platforms {.tabset} 
## 8.3.1 Protein Names in Display
```{r, warning=FALSE, message=FALSE}
DT::datatable(SigProSummary_DE)
```
# 8.3.2 - Overlap Counts
```{r, echo=FALSE, warning=FALSE, message=FALSE}
summary_df_DE <- read.csv(paste0(outPath2, "overlap_summary_counts.csv"))
DT::datatable(summary_df_DE)
```
