---
title: "Comparative Analysis of CSF Proteomics for Biomarker Discovery Across MS and Olink Platforms:
Protein Differential Expression and Associations with Clinical Traits"

# author: ""
# date: "`r Sys.Date()`"
output: 
  rmdformats::robobook:
    fig_width: 9
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.width = 6, fig.height = 4,
                      cache=FALSE, cache.lazy = FALSE,
                      fig.align = 'center',
                      tidy.opts = list(width.cutoff = 80), 
                      tidy = TRUE)

library(kableExtra)
```

```{=html}
<style type="text/css">
.book .book-body .page-inner {
max-width: 1600px;
margin-left: auto;
margin-right: auto;
}
details > summary {
display: list-item;
}
</style>
```       

# 1 - Global Summary of the Setting of this Study

1. We looked into proteomic data from three different platforms: Olink, Mass Spectrometry with bead depletion (BEADdel, named in this report) and Mass Spectrometry without bead depletion (NONdel, named in this report).

2. We performed two complementary approaches to explore the biomarkers: protein differential expression analysis (regression model with protein as response variable) and association testing between protein and clinical traits (regression model with protein as predictor variable), in order to capture the different pattern structure of the proteomic data.

3. Both differential expression analysis and association testing are performed per platform per clinical trait basis.

4. Clinical variables included in this report include: 
* "ALSvsHC", "ALSvsDC", "DCvsHC", "ALSFRSR_FINE_MOTOR"  "ALSFRSR_GROSS_MOTOR" "ALSFRSR_RATE" "ECAS_SCORE" 
* "BULBARvSpinal" (which is derived from WEAKNESS SITE, where "GENERALISED", "LOWER LIMB", "RESPIRATORY", "TRUNCAL", "UPPER LIMB" are grouped as "Spinal" 
* "C9vsNonC9", is derived from PATHOGENIC_VARIANT where ("KIF5A", "MAPT", "SBMA", "SOD1", "SPG7", "TBK1") are grouped as NonC9 (carriers).
* ALSFRSR_RATE is log transformed; ECAS_SCORE is boxcox transformed with retriction of maximum value of 134; "ALSFRSR_FINE_MOTOR"  "ALSFRSR_GROSS_MOTOR" are boxcox transformed with restrictions of maximum value of 12. 

5. Missing values are excluded per regression. Age and gender are confounding factors included per regression model.

> What does NPX mean? 
>
>> NPX, Normalized Protein eXpression, is Olink’s arbitrary unit which is in Log2 scale. It is calculated from Ct values and counts. For more information, refer to our white paper “Data normalization and standardization” which can be found on the Olink's [Documents]page.

# 2 - The Upshot

* There are consistent findings across different platforms. Potential biomarkers are 

* 

* 

* 

# 3 - Overlap for Samples and Proteins{.tabset}

<b><font face="Georgia" size="2em" color="firebrick"> Note: The overlapping are based on MS and Olink data sets after quality control and only the baseline samples are included in the analysis for this report.</font></b>

```{r, Load Data, echo=FALSE, warning=FALSE, message=FALSE, results=F}
library(kableExtra)
library(plotly)
library(DT)

inputPath <- "/home/rstudio/workspace/Data Collection/"
intermediatePath1 <- "/home/rstudio/workspace/Data Collection/intermediate_AssociationTesting/"
intermediatePath2 <- "/home/rstudio/workspace/Data Collection/intermediate_DifferentialExpression/"
outPath1 <- "/home/rstudio/workspace/Data Collection/output_AssociationTesting/"
outPath2 <- "/home/rstudio/workspace/Data Collection/output_DifferentialExpression/"
outPath <- "/home/rstudio/workspace/Data Collection/output_report/"

source("/home/rstudio/repos/DE_functions_call.R")

load(file = paste0(inputPath, "output_report/Load_Data_For_Report.rdata"))

platformList <- c("Olink", "BEADdel", "NONdel")

varAll_List <- c("ALSvsHC", "ALSvsDC", "DCvsHC", "BULBARvSpinal", "C9vsNonC9", "ALSFRSR_FINE_MOTOR", "ALSFRSR_GROSS_MOTOR", "ALSFRSR_RATE", "ECAS_SCORE")

varList_Conf <- c("AGE_AT_SYMPTOM_ONSET", "AGE_AT_SAMPLING","GENDER", "COHORT")
```

## 3.1 - Proteins{.tabset}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = colnames(Olink_ProF_matchClinic),
  "BEADdel" = colnames(BEADdel_ProF_matchClinic),
  "NONdel" = colnames(NONdel_ProF_matchClinic)
)

elements <- unique(unlist(set_list))  # Extract all unique elements from sets

binary_matrix <- as.data.frame(
  sapply(set_list, function(x) elements %in% x)
)
rownames(binary_matrix) <- elements
colnames(binary_matrix) <- names(set_list)

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),
  name = "Proteins in Platforms"
)
```


## 3.2 - Samples{.tabset}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = rownames(Olink_ProF_matchClinic),
  "BEADdel" = rownames(BEADdel_ProF_matchClinic),
  "NONdel" = rownames(NONdel_ProF_matchClinic)
)

elements <- unique(unlist(set_list))  
binary_matrix <- as.data.frame(
  sapply(set_list, function(set) elements %in% set)  
)
rownames(binary_matrix) <- elements  
colnames(binary_matrix) <- names(set_list) 

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),  
  name = "Samples in Platformss"  
)
```

# 4 - Clinincal Variable View{.tabset}
## All Clinical Variables {.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
load(file = paste0(intermediatePath1, "ClinicVar_View.Rdata"))
All_ClinicVar_View
```

## Olink{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
Olink_ClinicVar_View
```

## MS BEADdel{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
BEADdel_ClinicVar_View
```

## MS NONdel{.tabset}
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
NONdel_ClinicVar_View
```

# 6 - Volcano Plot{.tabset}
These plots are derived from the protein correlation coefficients obtained from the association testing model for each clinical trait.

```{r volcano_plots_by_trait, results='asis', echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=8}

# Load plots
load(paste0(intermediatePath, "volcano_panel_list.rdata"))
load(paste0(intermediatePath1, "plotly_volcano_list.rdata"))

for (trait in varAll_List) {
  
  out <- NULL
  
  out <- knitr::knit_expand(text = c(
    
    # Tab header for trait
    paste0("## ", trait, "\n"),
    
    # --- Chunk 1: Static Volcano Plot ---
    paste0("### Static Volcano Plot\n"),
    paste0("```{r StaticVolcano_", trait, ", echo=FALSE, fig.width=15, fig.height=8}"),
    paste0("print(volcano_panel_list[['", trait, "']])"),
    "```",
    
    # --- Chunk 2: Interactive Volcano Plots ---
    paste0("### Interactive Volcano Plots\n"),
    
    # Loop over platforms inside the knit_expand text
    paste0("{% for plat in platformList %}",
           "#### Platform: {{plat}}\n",
           "```{r InteractiveVolcano_", trait, "_{{plat}}, echo=FALSE, fig.width=15, fig.height=8}",
           "print(plotly_volcano_list[['", trait, "']][['{{plat}}']])",
           "```",
           "{% endfor %}")
  ))
  
  # Render the child content
  cat(knitr::knit_child(text = out, quiet = TRUE), sep = "\n")
}
```

# 7 - Pathway Enrichment Testing{.tabset}

# 7.1 - Pathway Enrichment Analysis Based on Association Testing, Using Proteins as Predictors{.tabset}
```{r pathway_enrichment_plots_association, results='asis', echo=FALSE, warning=FALSE, message=FALSE}

pathBaseList <- c("GOBP","GOMF","GOCC","REACTOME","KEGG","Biocarta","WikiPathways") 

for (trait in varAll_List) {
  
  out <- NULL
  
  out <- knitr::knit_expand(text = c(
    
    # --- Top-level tab: trait ---
    paste0("## ", trait, "\n"),
    
    # Loop over pathway databases
    paste0("{% for db in pathBaseList %}",
           "### ", "{{db}}", "\n")
  ))
  
  # Render top-level trait tab
  cat(knitr::knit_child(text = out, quiet = TRUE), sep = "\n")
  
  # Loop over pathway databases in R to render platform plots
  for (db in pathBaseList) {
    
    db_out <- NULL
    
    db_out <- knitr::knit_expand(text = c(
      # Nested tab header for pathway database
      paste0("#### ", db, "\n")
    ))
    
    # Render nested tab header
    cat(knitr::knit_child(text = db_out, quiet = TRUE), sep = "\n")
    
    # Loop over platforms for this trait + pathway
    for (plat in platformList) {
      
      file_path <- paste0(intermediatePath1, trait, "_", plat, "_", db, ".rdata")
      if (file.exists(file_path)) {
        load(file_path)
        
        plot_chunk <- knitr::knit_expand(text = c(
          paste0("```{r PathwayPlot_", trait, "_", plat, "_", db, ", echo=FALSE, fig.width=15, fig.height=8}"),
          paste0("generate_interactive_pathway_plot('", file_path, "', '", trait, "_", plat, "_", db, "')"),
          "```"
        ))
        
        cat(knitr::knit_child(text = plot_chunk, quiet = TRUE), sep = "\n")
        rm(comSFDat)
      }
    }
  }
}
```

# 7.2 - Pathway Enrichment Analysis Based on Differential Expression, Using Proteins as Response Variables{.tabset}
```{r pathway_enrichment_plots_DE, results='asis', echo=FALSE, warning=FALSE, message=FALSE}

for (trait in varAll_List) {
  
  out <- NULL
  
  out <- knitr::knit_expand(text = c(
    
    # --- Top-level tab: trait ---
    paste0("## ", trait, "\n"),
    
    # Loop over pathway databases
    paste0("{% for db in pathBaseList %}",
           "### ", "{{db}}", "\n")
  ))
  
  # Render top-level trait tab
  cat(knitr::knit_child(text = out, quiet = TRUE), sep = "\n")
  
  # Loop over pathway databases in R to render platform plots
  for (db in pathBaseList) {
    
    db_out <- NULL
    
    db_out <- knitr::knit_expand(text = c(
      # Nested tab header for pathway database
      paste0("#### ", db, "\n")
    ))
    
    # Render nested tab header
    cat(knitr::knit_child(text = db_out, quiet = TRUE), sep = "\n")
    
    # Loop over platforms for this trait + pathway
    for (plat in platformList) {
      
      file_path <- paste0(intermediatePath2, trait, "_", plat, "_", db, ".rdata")
      if (file.exists(file_path)) {
        load(file_path)
        
        plot_chunk <- knitr::knit_expand(text = c(
          paste0("```{r PathwayPlot_", trait, "_", plat, "_", db, ", echo=FALSE, fig.width=15, fig.height=8}"),
          paste0("generate_interactive_pathway_plot('", file_path, "', '", trait, "_", plat, "_", db, "')"),
          "```"
        ))
        
        cat(knitr::knit_child(text = plot_chunk, quiet = TRUE), sep = "\n")
        rm(comSFDat)
      }
    }
  }
}
```

# 8 - Summary Table of Overlapping Biomarker Candidate{.tabset} 

# 8.1 - Combined Biomarker Candidate from Two Complemetary Approaches with Comparisons Acorss the Three Platforms {.tabset} 
```{r,fig.height=30,fig.width=16,echo=FALSE, warning=FALSE, message=FALSE}
SigProSummary_AT <- read.csv(outPath1, "SigProSummary.csv")
SigProSummary_DE <- read.csv(outPath2, "SigProSummary.csv")

SigProSummary <- c(SigProSummary_AT, SigProSummary_DE)

DT::datatable(SigProSummary)
```

# 8.2 - Biomarker Candidate Derived from Association Testing with Comparisons Acorss the Three Platforms {.tabset} 
```{r,fig.height=30,fig.width=16,echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(SigProSummary_DE)
```

# 8.3 - Biomarker Candidate Derived from Differential Expression with Comparisons Acorss the Three Platforms {.tabset} 
```{r,fig.height=30,fig.width=16,echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(SigProSummary_DE)
```