---
title: "<span style='color:navy'>Comparative Analysis of CSF Proteomics for Biomarker Discovery Across MS and Olink Platforms: Protein Differential Expression and Associations with Clinical Traits</span>"

# author: ""
# date: "`r Sys.Date()`"
output: 
  rmdformats::robobook:
    fig_width: 9
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.width = 6, fig.height = 4,
                      cache=FALSE, cache.lazy = FALSE,
                      fig.align = 'center',
                      tidy.opts = list(width.cutoff = 80), 
                      tidy = TRUE)

library(kableExtra)
```

```{=html}
<style type="text/css">
.book .book-body .page-inner {
max-width: 1600px;
margin-left: auto;
margin-right: auto;
}
details > summary {
display: list-item;
}
</style>
```       

# 1 - Global Summary of the Setting of this Study

**1. Proteomic Platforms:**  
We analyzed proteomic data from three different platforms:  

- Olink. 
- Mass Spectrometry with bead depletion (BEADdel, referred to as BEADdel in this report).
- Mass Spectrometry without bead depletion (NONdel, referred to as NONdel in this report).

**2.Analytical Approaches:**  
Two complementary approaches were used to explore potential protei biomarkers:  
- Protein Differential Expression Analysis: Regression models with protein levels as the response variable.  
- Association Testing: Regression models with protein levels as the predictor variable.  

These approaches were chosen to capture different structural patterns in the proteomic data.

**3. Analysis Scope:**  
Both differential expression analysis and association testing were performed separately for each platform and each clinical trait. Statistical significance was defined as an adjusted p-value < 0.05, after correcting for multiple testing across all proteins evaluated.

**4. Clinical Variables:**  
The clinical variables included in this report are:  
- `"ALSvsHC"`, `"ALSvsDC"`, `"DCvsHC"`, `"ALSFRSR_FINE_MOTOR"`, `"ALSFRSR_GROSS_MOTOR"`, `"ALSFRSR_RATE"`, `"ECAS_SCORE"`  
- `"BULBARvSpinal"` – derived from `WEAKNESS_SITE`, where `"GENERALISED"`, `"LOWER LIMB"`, `"RESPIRATORY"`, `"TRUNCAL"`, and `"UPPER LIMB"` are grouped as `"Spinal"`  
- `"C9vsNonC9"` – derived from `PATHOGENIC_VARIANT`, where `"KIF5A", "MAPT", "SBMA", "SOD1", "SPG7", "TBK1"` are grouped as NonC9 carriers  
- `ALSFRSR_RATE` – log-transformed  
- `ECAS_SCORE` – Box-Cox transformed with a maximum value of 134  
- `ALSFRSR_FINE_MOTOR` and `ALSFRSR_GROSS_MOTOR` – Box-Cox transformed with a maximum value of 12

**5. Handling Missing Values and Confounders:**  
- Missing values were excluded on a per-regression basis.  
- Age and gender were included as confounding factors in all regression models.

**6. Pathway Enrichment Testing:**  
- Performed per platform and per clinical trait.  
- The pathway databases included are: `"GOBP"`, `"GOMF"`, `"GOCC"`, `"REACTOME"`, `"KEGG"`, `"Biocarta"`, and `"WikiPathways"`.  
- Ranked Gene Set Enrichment Testing was adopted, using the ranking metric:  
\[
\text{Rank} = -\log(p) \times \text{sign}(\beta)
\]  
where `p` and `β` are derived from the respective regression model.

# 2 - The Major Conclusions

<b><font face="Georgia" size="2em" color="firebrick"> Wait Avi to fill in. </font></b>

# 3 - Overlap for Samples and Proteins{.tabset}

<b><font face="Georgia" size="2em" color="firebrick"> Note: The overlapping are based on MS and Olink data sets after quality control and only the baseline samples are included in the analysis for this report.</font></b>

```{r, Load Data, echo=FALSE, warning=FALSE, message=FALSE, results=F}
library(kableExtra)
library(plotly)
library(DT)
library(stringr)
library(tidyverse)

inputPath <- "/home/rstudio/workspace/Data Collection/"
intermediatePath1 <- "/home/rstudio/workspace/Data Collection/intermediate_AssociationTesting/"
intermediatePath2 <- "/home/rstudio/workspace/Data Collection/intermediate_DifferentialExpression/"
outPath1 <- "/home/rstudio/workspace/Data Collection/output_AssociationTesting/"
outPath2 <- "/home/rstudio/workspace/Data Collection/output_DifferentialExpression/"
outPath <- "/home/rstudio/workspace/Data Collection/output_report/"

source("/home/rstudio/repos/DE_functions_call.R")

load(file = paste0(inputPath, "output_report/Load_Data_For_Report.rdata"))

platformList <- c("Olink", "BEADdel", "NONdel")

varAll_List <- c("ALSvsHC", "ALSvsDC", "DCvsHC", "BULBARvSpinal", "C9vsNonC9", "ALSFRSR_FINE_MOTOR", "ALSFRSR_GROSS_MOTOR", "ALSFRSR_RATE", "ECAS_SCORE")

varList_Conf <- c("AGE_AT_SYMPTOM_ONSET", "AGE_AT_SAMPLING","GENDER", "COHORT")
```

## 3.1 - Proteins{.tabset}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = colnames(Olink_ProF_matchClinic),
  "BEADdel" = colnames(BEADdel_ProF_matchClinic),
  "NONdel" = colnames(NONdel_ProF_matchClinic)
)

elements <- unique(unlist(set_list))  # Extract all unique elements from sets

binary_matrix <- as.data.frame(
  sapply(set_list, function(x) elements %in% x)
)
rownames(binary_matrix) <- elements
colnames(binary_matrix) <- names(set_list)

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),
  name = "Proteins in Platforms"
)
```


## 3.2 - Samples{.tabset}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set_list <- list(
  "Olink" = rownames(Olink_ProF_matchClinic),
  "BEADdel" = rownames(BEADdel_ProF_matchClinic),
  "NONdel" = rownames(NONdel_ProF_matchClinic)
)

elements <- unique(unlist(set_list))  
binary_matrix <- as.data.frame(
  sapply(set_list, function(set) elements %in% set)  
)
rownames(binary_matrix) <- elements  
colnames(binary_matrix) <- names(set_list) 

ComplexUpset::upset(
  binary_matrix,
  intersect = names(set_list),  
  name = "Samples in Platformss"  
)
```

# 4 - Clinincal Traits View
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
load(file = paste0(intermediatePath1, "ClinicVar_View.Rdata"))
All_ClinicVar_View
```

# 5 - Volcano Plot{.tabset}
These volcano plots are based on the protein coefficients and adjusted p-values obtained from the association testing models for each clinical trait.  

The reference groups for each categorical trait are as follows:

- ALSvsHC: reference group = HEALTHY CONTROL  
- DCvsHC: reference group = HEALTHY CONTROL  
- ALSvsDC: reference group = DISEASE CONTROL  
- BULBARvSpinal: reference group = BULBAR 
- C9vsNonC9: reference group = C9ORF72

```{r, results='asis', echo=FALSE, warning=FALSE, message=FALSE}

# Load plots
load(paste0(intermediatePath1, "volcano_panel_list.rdata"))
load(paste0(intermediatePath1, "plotly_volcano_list.rdata"))

for (trait in varAll_List) {
  
  out <- NULL
  
  # --- Chunk for static volcano plot ---
  uniq_id <- sample(1e6, 1)
  out <- knitr::knit_expand(text = c(
    paste0("## ", trait, "\n\n"),  # tab header for trait
    paste0("```{r StaticVolcano_", trait, "_", uniq_id, ", echo=FALSE, fig.width=15, fig.height=8}"),
    paste0("print(volcano_panel_list[['", trait, "']])"),
    "```"
  ))
  
  # --- Chunks for interactive plots ---
  for (plat in platformList) {
    uniq_id2 <- sample(1e6, 1)
    
    out <- c(out, knitr::knit_expand(text = c(
      "<div style='text-align: center;'>",  # start centering
      paste0("```{r InteractiveVolcano_", trait, "_", plat, "_", uniq_id2, 
             ", echo=FALSE, fig.width=8, fig.height=5}"),
      paste0("plotly_volcano_list[['", trait, "']][['", plat, "']]"),
      "```",
      "</div>"  # end centering
    )))
  }
  
  # Knit the child text to produce actual evaluated chunks
  cat(knitr::knit_child(text = out, quiet = TRUE), sep = "\n")
}

```

# 6 - Pathway Enrichment Testing{.tabset}

For each pathway database, gene set size between 10 and 1000 (inclusive) were included in the Gene Set Enrichment Analysis (GSEA).

- Only pathways meeting the significance threshold (padj < 0.05) are displayed. Point size represents −log(p-value), and color corresponds to the NES.
- Positive NES with significant adjusted p-value (padj) indicates that the pathway is activated/upregulated in the condition of interest.  
- Negative NES with significant padj indicates that the pathway is suppressed/downregulated.  
- Leading edge proteins are the subset of proteins driving the significance of the corresponding pathways.
- Blank indicates that no significantly enriched pathways were identified.

# 6.1 - Pathway Enrichment Analysis Based on Association Testing, Using Proteins as Predictors{.tabset}
```{r pathway_plots_nested_tabs, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
# Load pre-generated Plotly objects
load(paste0(outPath1, "ply_list.rdata"))

pathBaseList <- c("GOBP", "GOMF", "GOCC", "REACTOME", "KEGG", "Biocarta", "WikiPathways")

for (trait in varAll_List) {
  
  out <- NULL
  
  # ---- FIRST-LEVEL TAB: Clinical Trait ----
  # Add {.tabset} to enable second-level tabs
  out <- knitr::knit_expand(text = c(
    paste0("## ", trait, " {.tabset}\n\n")
  ))
  
  for (db in pathBaseList) {
    
    # ---- SECOND-LEVEL TAB: Database ----
    out <- c(out, knitr::knit_expand(text = c(
      paste0("### ", db, "\n\n")
    )))
    
    # Find matching entry in ply_list
    ply_pattern <- paste0(db, "_", trait)
    idx <- grep(ply_pattern, names(ply_list))
    
    if(length(idx) > 0) {
      key <- names(ply_list)[idx[1]]  # take first match
      chunk_label <- paste0("PlotChunk_", trait, "_", db, "_", sample(1e6, 1))  # unique label
      
      # Add the plot chunk
      out <- c(out, knitr::knit_expand(text = c(
        "<div style='text-align:center;'>",
        paste0("```{r ", chunk_label, ", echo=FALSE, fig.width=10, fig.height=10}"),
        paste0("ply_list[['", key, "']]"),
        "```",
        "</div>"
      )))
    } else {
      warning(paste0("No plot found for ", db, "_", trait))
    }
  }
  
  # Render all chunks for this trait tab
  cat(knitr::knit_child(text = out, quiet = TRUE), sep = "\n")
}
```

# 6.2 - Pathway Enrichment Analysis Based on Differential Expression, Using Proteins as Response Variables{.tabset}
```{r, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
load(paste0(outPath2, "ply_list.rdata"))

for (trait in varAll_List) {
  
  out <- NULL
  
  # ---- FIRST-LEVEL TAB: Clinical Trait ----
  # Add {.tabset} to enable second-level tabs
  out <- knitr::knit_expand(text = c(
    paste0("## ", trait, " {.tabset}\n\n")
  ))
  
  for (db in pathBaseList) {
    
    # ---- SECOND-LEVEL TAB: Database ----
    out <- c(out, knitr::knit_expand(text = c(
      paste0("### ", db, "\n\n")
    )))
    
    # Find matching entry in ply_list
    ply_pattern <- paste0(db, "_", trait)
    idx <- grep(ply_pattern, names(ply_list))
    
    if(length(idx) > 0) {
      key <- names(ply_list)[idx[1]]  # take first match
      chunk_label <- paste0("PlotChunk_", trait, "_", db, "_", sample(1e6, 1))  # unique label
      
      # Add the plot chunk
      out <- c(out, knitr::knit_expand(text = c(
        "<div style='text-align:center;'>",
        paste0("```{r ", chunk_label, ", echo=FALSE, fig.width=10, fig.height=10}"),
        paste0("ply_list[['", key, "']]"),
        "```",
        "</div>"
      )))
    } else {
      warning(paste0("No plot found for ", db, "_", trait))
    }
  }
  
  # Render all chunks for this trait tab
  cat(knitr::knit_child(text = out, quiet = TRUE), sep = "\n")
}
```

# 7 - Summary Table of Overlapping Biomarker Candidate{.tabset} 

# 7.1 - Combined Biomarker Candidate from Two Complemetary Approaches with Comparisons Acorss the Three Platforms {.tabset} 
## Protein Names in Display{.tabset} 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
SigProSummary_AT <- read.csv(paste0(outPath1, "SigProSummary.csv"))
SigProSummary_DE <- read.csv(paste0(outPath2, "SigProSummary.csv"))

# Get all unique ClinicalVar from both data frames
all_clinical <- SigProSummary_AT$ClinicalVar

# Initialize an empty list to store results
result_list <- vector("list", length(all_clinical))

# Function to merge protein strings
merge_proteins <- function(a, b) {
  a <- ifelse(is.na(a), "", a)
  b <- ifelse(is.na(b), "", b)
  combined <- unique(unlist(str_split(c(a, b), "/")))
  combined <- combined[combined != ""]
  paste(combined, collapse = "/")
}

# Loop over all ClinicalVar
for (i in seq_along(all_clinical)) {
  var <- all_clinical[i]
  
  row_AT <- SigProSummary_AT %>% filter(ClinicalVar == var)
  row_DE <- SigProSummary_DE %>% filter(ClinicalVar == var)
  
  BEADdel <- merge_proteins(if(nrow(row_AT) > 0) row_AT$BEADdel else NA,
                            if(nrow(row_DE) > 0) row_DE$BEADdel else NA)
  
  NONdel  <- merge_proteins(if(nrow(row_AT) > 0) row_AT$NONdel else NA,
                            if(nrow(row_DE) > 0) row_DE$NONdel else NA)
  
  Olink   <- merge_proteins(if(nrow(row_AT) > 0) row_AT$Olink else NA,
                            if(nrow(row_DE) > 0) row_DE$Olink else NA)
  
  result_list[[i]] <- data.frame(
    ClinicalVar = var,
    BEADdel = BEADdel,
    NONdel  = NONdel,
    Olink   = Olink,
    stringsAsFactors = FALSE
  )
}

# Combine into final data frame
SigProSummary <- bind_rows(result_list)

# View result
DT::datatable(SigProSummary)
```

## Overlap Counts Across Platforms{.tabset} 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
split_prots <- function(x) {
  if (is.na(x) || length(x) == 0) return(character(0))
  x <- as.character(x)
  x <- trimws(x)
  if (x == "") return(character(0))
  v <- unlist(strsplit(x, "/", fixed = TRUE))
  v <- trimws(v)
  v <- v[v != ""]
  # remove NA-like strings
  v <- v[!is.na(v) & v != "NA"]
  unique(v)
}

summary_list <- lapply(varAll_List, function(var) {
  # Get the row for this ClinicalVar (assume one row per ClinicalVar)
  row <- SigProSummary %>% filter(ClinicalVar == var) %>% slice(1)
  
  # Split protein strings into vectors (handle empty / NA)
  s_bead <- split_prots(row$BEADdel)
  s_non  <- split_prots(row$NONdel)
  s_ol   <- split_prots(row$Olink)
  
  # Compute overlaps (vectors)
  overlap_BEADdel_NONdel <- intersect(s_bead, s_non)
  overlap_BEADdel_Olink  <- intersect(s_bead, s_ol)
  overlap_NONdel_Olink   <- intersect(s_non, s_ol)
  overlap_all3           <- Reduce(intersect, list(s_bead, s_non, s_ol))
  
  # Helper to collapse names or return NA if none
  collapse_or_na <- function(vec) {
    if (length(vec) == 0) return(NA_character_)
    paste(vec, collapse = ", ")
  }
  
  # Return summary data.frame with exact names
  data.frame(
    ClinicalVar = var,
    Comparison = c("BEADdel vs NONdel", "BEADdel vs Olink", "NONdel vs Olink", "All three"),
    nProteins  = c(
      length(overlap_BEADdel_NONdel),
      length(overlap_BEADdel_Olink),
      length(overlap_NONdel_Olink),
      length(overlap_all3)
    ),
    Proteins = c(
      collapse_or_na(overlap_BEADdel_NONdel),
      collapse_or_na(overlap_BEADdel_Olink),
      collapse_or_na(overlap_NONdel_Olink),
      collapse_or_na(overlap_all3)
    ),
    stringsAsFactors = FALSE
  )
})

# Combine into a single data frame
summary_df <- bind_rows(summary_list)

# View interactive table
DT::datatable(summary_df, options = list(pageLength = 10))

split_proteins <- function(x) {
  if (is.na(x) || x == "") return(character(0))
  v <- unlist(str_split(x, "/", simplify = FALSE))
  v <- trimws(v)
  v <- v[v != "" & !is.na(v)]
  unique(v)
}

# Extract proteins from all three columns
all_proteins_list <- lapply(SigProSummary %>% select(BEADdel, NONdel, Olink),
                            function(col) unlist(lapply(col, split_proteins)))

# Combine and get unique proteins
SigPro_List <- unique(unlist(all_proteins_list))

```

## All the biomarker candidate across platforms and across all the clinical variables{.tabset} 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# helper to split slash-delimited protein strings
split_proteins <- function(x) {
  if (is.null(x) || all(is.na(x))) return(character(0))
  x <- as.character(x)
  # handle vector, collapse first (in case of multiple entries)
  x <- paste(x, collapse = "/")
  v <- unlist(str_split(x, "/", simplify = FALSE))
  v <- trimws(v)
  v <- v[v != "" & !is.na(v) & v != "NA"]
  unique(v)
}

# get lists of significant proteins from SigProSummary (any ClinicalVar)
sig_in_olink  <- unique(unlist(lapply(SigProSummary$Olink,  split_proteins)))
sig_in_bead   <- unique(unlist(lapply(SigProSummary$BEADdel, split_proteins)))
sig_in_nondel <- unique(unlist(lapply(SigProSummary$NONdel,  split_proteins)))

# all proteins list (you may already have SigPro_List)
SigPro_List <- sort(unique(SigPro_List))

# create an empty results data.frame
res_df <- data.frame(
  Protein = SigPro_List,
  Exist_in_Olink     = NA_character_,
  Exist_in_BEADdel   = NA_character_,
  Exist_in_NONdel    = NA_character_,
  Significant_in_Olink   = NA_character_,
  Significant_in_BEADdel = NA_character_,
  Significant_in_NONdel  = NA_character_,
  HighLowAbundance_DilutionBin_in_Olink = NA_character_,  # placeholder
  Protein_Detectability_in_Olink_percent = NA_character_,        # placeholder
  stringsAsFactors = FALSE
)

# fill existence columns based on whether protein name appears in the expression data column names
# (assumes Olink_ProF, BEADdel_ProF, NONdel_ProF are data.frames / matrices with proteins as column names)
for (i in seq_len(nrow(res_df))) {
  p <- res_df$Protein[i]
  res_df$Exist_in_Olink[i]   <- if (p %in% colnames(Olink_ProF))   "YES" else "NO"
  res_df$Exist_in_BEADdel[i] <- if (p %in% colnames(BEADdel_ProF)) "YES" else "NO"
  res_df$Exist_in_NONdel[i]  <- if (p %in% colnames(NONdel_ProF))  "YES" else "NO"
  
  # significant: check whether protein appears anywhere in SigProSummary's Olink/BEADdel/NONdel lists
  res_df$Significant_in_Olink[i]   <- if (p %in% sig_in_olink)  "YES" else "NO"
  res_df$Significant_in_BEADdel[i] <- if (p %in% sig_in_bead)   "YES" else "NO"
  res_df$Significant_in_NONdel[i]  <- if (p %in% sig_in_nondel) "YES" else "NO"
}

# Make sure types are consistent
res_df <- res_df %>%
  mutate(
    Exist_in_Olink = as.character(Exist_in_Olink),
    Exist_in_BEADdel = as.character(Exist_in_BEADdel),
    Exist_in_NONdel = as.character(Exist_in_NONdel),
    Significant_in_Olink = as.character(Significant_in_Olink),
    Significant_in_BEADdel = as.character(Significant_in_BEADdel),
    Significant_in_NONdel = as.character(Significant_in_NONdel)
  )

# Read in the detectability information
CSF_Pro_Filter_Frame <- read.csv(paste0(inputPath, "Data-CSF/oxf-da28-opdc-als-multiple-cohorts-olink-csf/CSF_Pro_Filter_Frame.csv"), row.names = 1)

res_df$Protein_Detectability_in_Olink <- CSF_Pro_Filter_Frame[res_df$Protein, "Detectability_FIXEDlod_Protein..."]

# Read in Dilution Bins

Raw_Olink_CSF <- read.csv("/home/rstudio/workspace/Data Collection/Data-CSF/oxf-da28-opdc-als-multiple-cohorts-olink-csf/P230192_CSP1-5_CINO_and_C2I2N2O2_EXTENDED_NPX_2024-01-18_cleaned.csv", sep = ";")

res_df$HighLowAbundance_DilutionBin_in_Olink <- sapply(res_df$Protein, function(x){Raw_Olink_CSF$Panel[which(Raw_Olink_CSF$Assay == x)[1]]})

# View interactive table
DT::datatable(res_df, options = list(pageLength = 20), rownames = FALSE)

```

# 7.2 - Biomarker Candidate Derived from Association Testing with Comparisons Acorss the Three Platforms {.tabset} 
## Protein Names in Display{.tabset} 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(SigProSummary_DE)
```
## Overlap Counts{.tabset} 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
summary_df_AT <- read.csv(paste0(outPath1, "overlap_summary_counts.csv"))
DT::datatable(summary_df_AT)
```

# 7.3 - Biomarker Candidate Derived from Differential Expression with Comparisons Acorss the Three Platforms {.tabset} 
## Protein Names in Display{.tabset} 
```{r, warning=FALSE, message=FALSE}
DT::datatable(SigProSummary_DE)
```
## Overlap Counts{.tabset} 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
summary_df_DE <- read.csv(paste0(outPath2, "overlap_summary_counts.csv"))
DT::datatable(summary_df_DE)
```
